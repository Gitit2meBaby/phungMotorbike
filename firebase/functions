const functions = require('firebase-functions');
const admin = require('firebase-admin');
const sharp = require('sharp');
const path = require('path');
const os = require('os');
const fs = require('fs');

admin.initializeApp();

exports.resizeImages = functions.storage.object().onFinalize(async (object) => {
    const bucket = admin.storage().bucket(object.bucket);
    const filePath = object.name;
    const contentType = object.contentType;

    if (!contentType.startsWith('image/')) {
        console.log('Not an image file, skipping.');
        return null;
    }

    const fileName = path.basename(filePath);
    const tempFilePath = path.join(os.tmpdir(), fileName);
    await bucket.file(filePath).download({ destination: tempFilePath });

    const thumbPath = tempFilePath.replace(/\.[^/.]+$/, '-thumb.webp');
    const fullPath = tempFilePath.replace(/\.[^/.]+$/, '-landScape.webp');

    await sharp(tempFilePath).resize(300, 225).toFormat('webp').toFile(thumbPath);
    await sharp(tempFilePath).resize(600, 450).toFormat('webp').toFile(fullPath);

    await bucket.upload(thumbPath, {
        destination: filePath.replace(/\.[^/.]+$/, '-thumb.webp'),
    });
    await bucket.upload(fullPath, {
        destination: filePath.replace(/\.[^/.]+$/, '-landScape.webp'),
    });

    fs.unlinkSync(tempFilePath);
    fs.unlinkSync(thumbPath);
    fs.unlinkSync(fullPath);

    return null;
});
